<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://kit.fontawesome.com/15277ee0a1.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="container">
    <div class="row">
        <div class="col-15 col-sm-10 col-lg-6">
            <h6 class="text-muted">Fridge food list</h6>

            <div class="d-flex justify-content-center">
                <button id = "getAllProducts" type="button" class="btn btn-outline-dark btn-sm">All product</button>
                <button id = "getExpiredProducts" type="button" class="btn btn-outline-dark btn-sm">Expired products</button>
            </div>

            <ul class="list-group" id="productsList" style="height:300px;width:600px;overflow-y:scroll;">

            </ul>
        </div>
    </div>

    <button type="button" class="button" data-bs-toggle="modal" data-bs-target="#exampleModal">
        Add product
    </button>
</div>


<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal header">
            <h2>Product edit</h2>
        </div>

        <div class="modal-content">

            <a class="close" href="#">&times;</a>
            <div class="content">
                <form>
                    <div class="form-group"><label for="name">Name:</label> <input type="text" id="name" name="name"
                                                                                   required></div>
                    <div class="form-group"><label for="category">Category:</label> <select id="category"
                                                                                            class="form-select form-select-sm"
                                                                                            aria-label=".form-select-sm example">
                        <option selected>Open this select menu</option>
                        <option value="Fruit">Fruit</option>
                        <option value="Vegetable">Vegetable</option>
                        <option value="MeatProduct">MeatProduct</option>
                    </select></div>
                    <div class="form-group"><label for="photo">Photo:</label> <input type="file" id="photo" name="photo"
                                                                                     required></div>
                    <div class="datetimepicker">
                        <div class="form-group"><label for="date">Date:</label> <input type="date" id="date"
                                                                                      ></div>
                        <div class="form-group"><label for="time">Time:</label> <input type="time" id="time" value="08:00"></div>
                    </div>
                    <p>
                        <label>Reminder period: </label>
                        <input type="number" step="1" min="0" value="1" id="period"/>
                    </p>

                </form>
            </div>
            <div class="modal-footer">
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="addProductButton">Add product</button>
                </div>
            </div>
        </div>
    </div>




<script>
    const url = 'http://localhost:8080';
    const addProductButton = document.getElementById("addProductButton");
    const listProducts = document.getElementById("productsList");
    const getProductsButton = document.getElementById("getAllProducts");
    const getExpiredProductsButton = document.getElementById("getExpiredProducts");
    const dateValue = document.getElementById('date');
    const timeValue = document.getElementById('time');

    function connect() {
        let socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe("/topic/messages", function (message) {

                var modalHtml = '<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">';
                modalHtml += '<div class="modal-dialog" role="document">';
                modalHtml += '<div class="modal-content">';
                modalHtml += '<div class="modal-header">';
                modalHtml += '<h5 class="modal-title" id="myModalLabel">Product info</h5>';
                modalHtml += '<button type="button" class="close" data-dismiss="modal" aria-label="Close">';
                modalHtml += '<span aria-hidden="true">&times;</span>';
                modalHtml += '</button>';
                modalHtml += '</div>';
                modalHtml += '<div class="modal-body">';
                modalHtml += '<p>' + message.body + '</p>';
                modalHtml += '</div>';
                modalHtml += '</div>';
                modalHtml += '</div>';
                modalHtml += '</div>';
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                $('#myModal').modal('show')
                getProductsRequest();
            });
        });
    }

    const state = {
        products: [],
        newProduct: {
            id: '',
            expirationDate: '',
            image: null,
            productName: '',
            reminderPeriod: ''
        }
    }
    var options = {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        second: 'numeric'
    };
    var productName = document.getElementById("name");
    var photoInput = document.getElementById("photo");
    var date = document.getElementById("date");
    var productType = document.getElementById("category");
    var listGroup = document.getElementById('productsList');
    var periodInput = document.getElementById('period')
    document.addEventListener('DOMContentLoaded', async () => {
        connect();
        await getProductsRequest();

    })
    addProductButton.addEventListener("click", function () {

        state.newProduct.productName = productName.value;
        datetimeValue = dateValue.value + 'T' + timeValue.value;
        //state.newProduct.expirationDate = date.value;
        state.newProduct.expirationDate = datetimeValue;
        state.newProduct.reminderPeriod = periodInput.value;
        const json = JSON.stringify(state.newProduct);
        const blob = new Blob([json], {
            type: 'application/json'
        });
        const formData = new FormData();
        formData.append("image", photoInput.files[0]);
        formData.append("product", blob);
        formData.append("productType", productType.value)
        fetch(url + "/addProduct", {
            method: "POST",
            body: formData
        })
            .then(function (response) {
                if (response.ok) {
                    console.log("success")
                } else {
                    console.log("error")
                }
            })
            .catch(function (error) {

                console.log(error);
            });
    });
    getProductsButton.addEventListener('click',async () => {
        await getProductsRequest();
    })
    getExpiredProductsButton.addEventListener('click',async () => {
        await getExpiredProductsRequest();
    })
    function getProductsRequest() {
        return fetch(url + "/getProduct", {
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            }
        })
            .then((res) => res.json())
            .then(products => renderProductList(products))
            .catch(error => console.error(error));
    }

    function getExpiredProductsRequest() {
        return fetch(url + "/expiredProducts", {
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            }
        })
            .then((res) => res.json())
            .then(products => renderProductList(products))
            .catch(error => console.error(error));
    }

    function renderProductList(products) {
        listGroup.innerHTML = '';
        products.forEach(function (product) {
            createProductListItem(product);
        });
    }

    function createProductListItem(data) {

        var listItem = document.createElement('a');
        listItem.setAttribute('href', '#');
        listItem.classList.add('list-group-item', 'list-group-item-action', 'd-flex', 'justify-content-between', 'align-items-center');

// Створення блоку змісту
        var contentDiv = document.createElement('div');
        contentDiv.classList.add('flex-column');
// Додавання заголовка
        var title = document.createTextNode(data.productName);
        var titleElement = document.createElement('p');
        titleElement.appendChild(title);
        contentDiv.appendChild(titleElement);

// Додавання автора
        var author = document.createTextNode(data.type);
        var authorElement = document.createElement('p');
        authorElement.appendChild(author);
        contentDiv.appendChild(authorElement);

// Додавання значка
        var badgeSpan = document.createElement('span');
        if(data.expiredStatus === true){
            badgeSpan.classList.add('badge', 'badge-danger', 'badge-pill');
        }
        else
        {
            badgeSpan.classList.add('badge', 'badge-info', 'badge-pill');
        }
        var date = new Date(data.expirationDate[0],data.expirationDate[1],data.expirationDate[2],data.expirationDate[3],data.expirationDate[4]);
        //badgeSpan.textContent = date.toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
         options = { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric' };
        badgeSpan.textContent = date.toLocaleString(undefined, options);



        contentDiv.appendChild(badgeSpan);

        // Додавання іконки видалення
        var deleteIcon = document.createElement('i');
        deleteIcon.addEventListener('click', () => {
            deleteProduct(data.id)
        });
        deleteIcon.classList.add('fas', 'fa-trash-alt');
        contentDiv.appendChild(deleteIcon);

// Додавання блоку змісту до елемента списку
        listItem.appendChild(contentDiv);

// Створення блоку зображення
        var imageDiv = document.createElement('div');
        imageDiv.classList.add('image-parent');


// Створення зображення
        var image = document.createElement('img');
        image.setAttribute('src', 'data:image/jpeg;base64,' + data.image);
        image.classList.add('img-fluid');
        image.setAttribute('alt', 'quixote');
        imageDiv.appendChild(image);


// Додавання блоку зображення до елемента списку
        listItem.appendChild(imageDiv);

// Додавання елемента списку до DOM-дерева
        listGroup.appendChild(listItem);
    }

    function deleteProduct(id) {
        return fetch(`http://localhost:8080/deleteProduct/${id}`, {
            method: 'DELETE'
        })
    }


</script>
</body>
</html>